<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <title>Master Tour Summary (All Data)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 100%; margin: 0 auto; }
        
        /* NAV */
        .nav-bar { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-btn { padding: 8px 15px; text-decoration: none; color: white; background: #7f8c8d; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .nav-btn.active { background: #2c3e50; border: 2px solid #f1c40f; } 

        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .row { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 20px; }
        
        select { padding: 10px; font-size: 16px; border: 2px solid #27ae60; border-radius: 4px; width: 300px; }
        .btn-copy { background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-copy:hover { background: #2ecc71; }

        /* DATA TABLE */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
            font-size: 11px; /* Small font to fit everything */
            font-family: Arial, sans-serif; 
        }
        th, td { 
            border: 1px solid #999; 
            padding: 6px; 
            text-align: left; 
            vertical-align: top;
        }
        th { background-color: #dcdcdc; font-weight: bold; text-transform: uppercase; }
        
        /* Visual Indicators for Categories */
        .row-hotel { border-left: 5px solid #2980b9; }
        .row-camp { border-left: 5px solid #e67e22; }
        .row-rest { border-left: 5px solid #e74c3c; }
        .row-gh { border-left: 5px solid #8e44ad; }
        .row-attr { border-left: 5px solid #16a085; }
        .row-trans { border-left: 5px solid #2c3e50; }
        .row-nomad { border-left: 5px solid #795548; }

        /* Utility */
        .money { font-weight: bold; color: #2c3e50; }
        .sub-text { color: #666; font-size: 10px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <a href="index.html" class="nav-btn">1. HOTEL</a> 
        <a href="camp.html" class="nav-btn">2. CAMP</a> 
        <a href="restaurant.html" class="nav-btn">3. RESTAURANT</a> 
        <a href="guesthouse.html" class="nav-btn">4. GUEST HOUSE</a> 
        <a href="attraction.html" class="nav-btn">5. ҮЗВЭР</a> 
        <a href="transport.html" class="nav-btn">6. ТЭЭВЭР</a> 
        <a href="nomad.html" class="nav-btn">7. МАЛЧИН</a> 
        <a href="summary.html" class="nav-btn active">8. НЭГДСЭН ДҮН</a>
    </div>

    <div class="card">
        <div class="row">
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:5px;">Аялал Сонгох (Select Trip):</label>
                <select id="tripSelect" onchange="generateReport()"><option value="">-- Аялал сонгоно уу --</option></select>
            </div>
            <div>
                <button class="btn-copy" onclick="copyToClipboard()">COPY TO GOOGLE SHEETS</button>
            </div>
            <div style="margin-left: auto; font-size: 18px; font-weight: bold;">
                Total Trip Cost: <span id="grandTotalDisplay">0</span> ₮
            </div>
        </div>

        <div id="tableContainer">
            <table id="masterTable">
                <thead>
                    <tr>
                        <th style="width:80px;">Date (Огноо)</th>
                        <th style="width:100px;">Category</th>
                        <th style="width:150px;">Service Name (Нэр)</th>
                        <th>Accommodation / Route / Menu (Дэлгэрэнгүй)</th>
                        <th>Pax (Хүмүүс)</th>
                        <th>Food / Meals (Хоол)</th>
                        <th>Extras / Guide / Info (Бусад)</th>
                        <th>Total Cost (Дүн)</th>
                        <th>Status (Нэх/Төл)</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- LOAD ALL DATA ---
    let trips = JSON.parse(localStorage.getItem('np_trips')) || [];

    // Helper to format numbers
    const fmt = (num) => num ? parseInt(num).toLocaleString() : '0';

    window.onload = function() {
        let sel = document.getElementById('tripSelect');
        trips.forEach(t => sel.add(new Option(t, t)));
    };

    function generateReport() {
        const tripName = document.getElementById('tripSelect').value;
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        let grandTotal = 0;
        let allItems = [];

        if(!tripName) return;

        // --- 1. GATHER HOTEL DATA ---
        let hotels = JSON.parse(localStorage.getItem('np_hotel_pro_v3')) || [];
        hotels.forEach(x => {
            if(x.trip === tripName) {
                // Build Room String
                let roomStr = "";
                if(x.rooms) x.rooms.forEach(r => roomStr += `${r.type} x${r.count} (${fmt(r.price)}), `);
                
                // Build Food String
                let foodStr = "";
                if(x.bfQty>0) foodStr += `BF: ${x.bfQty}x${fmt(x.bfPrice)} <br>`;
                if(x.lnQty>0) foodStr += `LN: ${x.lnQty}x${fmt(x.lnPrice)} <br>`;
                if(x.dnQty>0) foodStr += `DN: ${x.dnQty}x${fmt(x.dnPrice)}`;

                allItems.push({
                    date: x.checkIn,
                    cat: "HOTEL",
                    css: "row-hotel",
                    name: x.hotel,
                    desc: roomStr,
                    pax: `Total Pax: ${x.paxCount} <br> Nights: ${x.nights}`,
                    food: foodStr,
                    extra: `${x.extraName || '-'} (${fmt(x.extraPrice)}) <br> Disc: -${fmt(x.discount)}`,
                    cost: x.grandTotal,
                    status: `Inv:${x.invDate} <br> Pd:${x.paidDate}`
                });
                grandTotal += parseFloat(x.grandTotal.replace(/,/g,'')) || 0;
            }
        });

        // --- 2. GATHER CAMP DATA ---
        let camps = JSON.parse(localStorage.getItem('np_camp_compact_v2')) || [];
        camps.forEach(x => {
            if(x.trip === tripName) {
                let foodStr = `BF:${x.bfQty} / LN:${x.lnQty} / DN:${x.dnQty} <br> (Unit Prices Hidden)`; // Simplified as per camp logic
                
                allItems.push({
                    date: x.checkIn,
                    cat: "CAMP",
                    css: "row-camp",
                    name: x.camp,
                    desc: `${x.accomType} (${x.roomConfig})`,
                    pax: `For: ${x.forAdlQty}A/${x.forChdQty}C <br> Mon: ${x.monAdlQty}A`,
                    food: foodStr,
                    extra: `${x.extraName || '-'} (${fmt(x.extraPrice)})`,
                    cost: x.grandTotal,
                    status: `Inv:${x.invDate} <br> Pd:${x.paidDate}`
                });
                grandTotal += parseFloat(x.grandTotal.replace(/,/g,'')) || 0;
            }
        });

        // --- 3. GATHER RESTAURANT DATA ---
        let rests = JSON.parse(localStorage.getItem('np_restaurant_v1')) || [];
        rests.forEach(x => {
            if(x.trip === tripName) {
                allItems.push({
                    date: x.date,
                    cat: "RESTAURANT",
                    css: "row-rest",
                    name: x.restaurant,
                    desc: `Menu: ${x.menuName} (${fmt(x.menuPrice)})`,
                    pax: `F: ${x.paxForeign} <br> M: ${x.paxMongol}`,
                    food: "Menu Order",
                    extra: `Guide: ${x.guideName} <br> Phone: ${x.guidePhone}`,
                    cost: x.grandTotal,
                    status: `Inv:${x.invDate} <br> Pd:${x.paidDate}`
                });
                grandTotal += parseFloat(x.grandTotal.replace(/,/g,'')) || 0;
            }
        });

        // --- 4. GATHER GUEST HOUSE DATA ---
        let ghs = JSON.parse(localStorage.getItem('np_gh_bookings')) || [];
        ghs.forEach(x => {
            if(x.trip === tripName) {
                let foodStr = `BF:${x.bfQty} / LN:${x.lnQty} / DN:${x.dnQty}`;
                allItems.push({
                    date: x.checkIn,
                    cat: "GUEST HOUSE",
                    css: "row-gh",
                    name: x.gh,
                    desc: `${x.accomType} (${x.roomConfig})`,
                    pax: `F: ${x.forAdlQty}/${x.forChdQty} <br> M: ${x.monAdlQty}`,
                    food: foodStr,
                    extra: `${x.extraName} (${fmt(x.extraPrice)})`,
                    cost: x.grandTotal,
                    status: `Inv:${x.invDate} <br> Pd:${x.paidDate}`
                });
                grandTotal += parseFloat(x.grandTotal.replace(/,/g,'')) || 0;
            }
        });

        // --- 5. GATHER ATTRACTION DATA ---
        let attrs = JSON.parse(localStorage.getItem('np_attraction_v2')) || [];
        attrs.forEach(x => {
            if(x.trip === tripName) {
                allItems.push({
                    date: x.date,
                    cat: "ATTRACTION",
                    css: "row-attr",
                    name: x.attr,
                    desc: "Entry Fee",
                    pax: `Adl: ${x.adlQty} x${fmt(x.adlPrice)} <br> Chd: ${x.chdQty} x${fmt(x.chdPrice)}`,
                    food: "-",
                    extra: `Guide: ${x.guide} <br> ${x.phone}`,
                    cost: x.total,
                    status: `Inv:${x.inv} <br> Pd:${x.paid}`
                });
                grandTotal += parseFloat(x.total.replace(/,/g,'')) || 0;
            }
        });

        // --- 6. GATHER TRANSPORT DATA ---
        let trans = JSON.parse(localStorage.getItem('np_transport_v2')) || [];
        trans.forEach(x => {
            if(x.trip === tripName) {
                allItems.push({
                    date: x.date,
                    cat: "TRANSPORT",
                    css: "row-trans",
                    name: x.trans,
                    desc: `${x.type} - ${x.route}`,
                    pax: `Adl: ${x.adlQty} <br> Chd: ${x.chdQty}`,
                    food: "-",
                    extra: `Driver: ${x.guideName} (${x.guidePhone}) <br> <b>Passengers:</b> <br> ${x.paxList.substring(0,50)}...`,
                    cost: x.total,
                    status: `Inv:${x.inv} <br> Pd:${x.paid}`
                });
                grandTotal += parseFloat(x.total.replace(/,/g,'')) || 0;
            }
        });

        // --- 7. GATHER NOMAD DATA ---
        let nomads = JSON.parse(localStorage.getItem('np_nomad_v2')) || [];
        nomads.forEach(x => {
            if(x.trip === tripName) {
                let horseStr = `Horse: ${parseInt(x.horsePax)+parseInt(x.horseGuide)} pax (${x.horseDays} days)`;
                let camelStr = (x.camelPax > 0) ? `<br>Camel: ${x.camelPax} pax` : "";
                
                allItems.push({
                    date: x.inDate,
                    cat: "NOMAD",
                    css: "row-nomad",
                    name: x.nomad,
                    desc: "Ger Stay (" + x.days + " days)",
                    pax: `For: ${x.paxF} <br> Mon: ${x.paxM}`,
                    food: `Food Cost: ${fmt(x.foodPrice)}`,
                    extra: horseStr + camelStr + `<br> Extra: ${x.extraName}`,
                    cost: x.total,
                    status: `Inv:${x.inv} <br> Pd:${x.paid}`
                });
                grandTotal += parseFloat(x.total.replace(/,/g,'')) || 0;
            }
        });

        // --- RENDER ALL ---
        allItems.sort((a, b) => (a.date > b.date) ? 1 : -1);

        allItems.forEach(row => {
            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="${row.css}">${row.date}</td>
                <td><b>${row.cat}</b></td>
                <td>${row.name}</td>
                <td>${row.desc}</td>
                <td>${row.pax}</td>
                <td>${row.food}</td>
                <td>${row.extra}</td>
                <td class="money">${row.cost}</td>
                <td class="sub-text">${row.status}</td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('grandTotalDisplay').innerText = grandTotal.toLocaleString();
    }

    function copyToClipboard() {
        const table = document.getElementById('masterTable');
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        window.getSelection().removeAllRanges();
        alert('Copied! Open Google Sheets and press Ctrl+V');
    }
</script>

</body>
</html>
