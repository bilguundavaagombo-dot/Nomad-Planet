<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù—ç–≥–¥—Å—ç–Ω –¢–∞–π–ª–∞–Ω (Final Summary)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 100%; margin: 0 auto; }
        .nav-bar { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-btn { padding: 8px 15px; text-decoration: none; color: white; background: #7f8c8d; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .nav-btn.active { background: #2c3e50; border: 2px solid #f1c40f; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .row { display: flex; align-items: flex-end; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        select { padding: 10px; font-size: 16px; border: 2px solid #27ae60; border-radius: 4px; min-width: 280px; }
        button { padding: 10px 18px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-copy { background: #27ae60; color: white; }
        .btn-copy:hover { background: #2ecc71; }
        .btn-tsv { background: #e67e22; color: white; }
        .btn-tsv:hover { background: #f39c12; }
        table {
            width: 100%; border-collapse: collapse; background: white; font-size: 12px;
            font-family: Arial, sans-serif; border: 1px solid #000; margin-bottom: 20px;
        }
        th, td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #dcdcdc; font-weight: bold; text-transform: uppercase; }
        .trip-header { background-color: #4a69bd; color: white; font-size: 18px; text-align: center; padding: 15px; }
        .row-hotel { border-left: 5px solid #2980b9; }
        .row-camp { border-left: 5px solid #e67e22; }
        .row-rest { border-left: 5px solid #e74c3c; }
        .row-gh { border-left: 5px solid #8e44ad; }
        .row-attr { border-left: 5px solid #16a085; }
        .row-trans { border-left: 5px solid #2c3e50; }
        .row-nomad { border-left: 5px solid #795548; }
        tfoot tr td { background-color: #f9e79f; font-weight: bold; font-size: 13px; }
        .money-cell { text-align: right; white-space: nowrap; }
        .category-selection { display: flex; flex-wrap: wrap; gap: 12px; margin: 15px 0; }
        .category-selection label { font-size: 14px; display: flex; align-items: center; }
        .category-selection input { margin-right: 6px; }
    </style>
</head>
<body>
<div class="container">
    <div class="nav-bar">
        <a href="index.html" class="nav-btn">1. HOTEL (–ë—É—É–¥–∞–ª)</a>
        <a href="restaurant.html" class="nav-btn">2. RESTAURANT</a>
        <a href="attraction.html" class="nav-btn">3. “Æ–ó–í–≠–†</a>
        <a href="nomad.html" class="nav-btn">4. –ú–ê–õ–ß–ò–ù</a>
        <a href="camp.html" class="nav-btn">5. CAMP (–ë–∞–∞–∑)</a>
        <a href="guesthouse.html" class="nav-btn">6. GUEST HOUSE</a>
        <a href="transport.html" class="nav-btn">7. –¢–≠–≠–í–≠–†</a>
        <a href="summary.html" class="nav-btn active">8. –ù–≠–ì–î–°–≠–ù –î“Æ–ù</a>
    </div>

    <div class="card">
        <div class="row">
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:5px;">–ê—è–ª–∞–ª –°–æ–Ω–≥–æ—Ö:</label>
                <select id="tripSelect" onchange="generateReport()">
                    <option value="">-- –ê—è–ª–∞–ª —Å–æ–Ω–≥–æ–Ω–æ —É—É --</option>
                    <option value="all">–ë“Æ–• –ê–Ø–õ–ê–õ</option>
                </select>
            </div>
            <div style="display:flex; gap:10px; align-items:flex-end;">
                <button class="btn-copy" onclick="copyVisibleTablesAsHTML()">üìã HTML —Ö—É—É–ª–∞—Ö (—Å–æ–Ω–≥–æ–æ–¥ —Ö—É—É–ª–∞—Ö)</button>
                <button class="btn-tsv" onclick="copyVisibleTablesAsTSV()">üìã TSV —Ö—É—É–ª–∞—Ö (Sheets-–¥ —à—É—É–¥ –Ω–∞–∞—Ö)</button>
            </div>
        </div>

        <div class="category-selection">
            <label style="font-weight:bold; margin-right:15px;">–ê–Ω–≥–∏–ª–∞–ª:</label>
            <label><input type="checkbox" id="cat-hotel" checked onchange="generateReport()"> –ë—É—É–¥–∞–ª</label>
            <label><input type="checkbox" id="cat-rest" checked onchange="generateReport()"> –†–µ—Å—Ç–æ—Ä–∞–Ω</label>
            <label><input type="checkbox" id="cat-attr" checked onchange="generateReport()"> “Æ–∑–≤—ç—Ä</label>
            <label><input type="checkbox" id="cat-nomad" checked onchange="generateReport()"> –ú–∞–ª—á–∏–Ω</label>
            <label><input type="checkbox" id="cat-camp" checked onchange="generateReport()"> –ë–∞–∞–∑</label>
            <label><input type="checkbox" id="cat-gh" checked onchange="generateReport()"> –ì—ç—Å—Ç —Ö–∞—É—Å</label>
            <label><input type="checkbox" id="cat-trans" checked onchange="generateReport()"> –¢—ç—ç–≤—ç—Ä</label>
        </div>

        <div id="tableContainer"></div>
    </div>
</div>

<script>
// --- LOAD DATA ---
let trips = JSON.parse(localStorage.getItem('np_trips')) || [];

// Helper: Number Format
const fmt = (num) => num ? parseInt(num).toLocaleString('mn-MN') : '0';

window.onload = function() {
    let sel = document.getElementById('tripSelect');
    trips.forEach(t => sel.add(new Option(t, t)));
};

function generateReport() {
    const tripName = document.getElementById('tripSelect').value;
    const container = document.getElementById('tableContainer');
    container.innerHTML = '';
    if (!tripName) return;

    let allItems = [];
    let groupedItems = {};

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Collect functions (same as before, just refactored slightly)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const collect = (key, tripFilter, mapper) => {
        let data = JSON.parse(localStorage.getItem(key)) || [];
        data.forEach(x => {
            if (tripFilter === 'all' || x.trip === tripFilter) {
                let item = mapper(x);
                allItems.push(item);
                if (!groupedItems[x.trip]) groupedItems[x.trip] = [];
                groupedItems[x.trip].push(item);
            }
        });
    };

    collect('np_hotel_pro_v3', tripName, x => ({
        trip: x.trip, date: x.checkIn, cat: "HOTEL", css: "row-hotel",
        name: x.hotel, desc: (x.rooms?.map(r => `${r.type} x${r.count}`).join(', ') || '') + ` (${x.nights} —Ö–æ–Ω–æ–≥)`,
        pax: `Total: ${x.paxCount}`, food: `BF:${fmt(x.bfPrice)}, LN:${fmt(x.lnPrice)}, DN:${fmt(x.dnPrice)}`,
        guide: "-", cost: parseFloat(x.grandTotal?.replace(/,/g,'')||0),
        paid: x.paidDate ? parseFloat(x.grandTotal?.replace(/,/g,'')||0) : 0,
        status: `–ù—ç—Ö: ${x.invDate||'-'}<br>–¢”©–ª: ${x.paidDate||'-'}`
    }));

    collect('np_camp_pro_v3', tripName, x => ({
        trip: x.trip, date: x.checkIn, cat: "CAMP", css: "row-camp",
        name: x.camp, desc: `${x.roomType||'Standard'} (${x.nights} —Ö–æ–Ω–æ–≥)`,
        pax: `F:${x.faQty}, C:${x.fcQty}, S:${x.stQty}`,
        food: `BF:${fmt(x.bfPrice)}, LN:${fmt(x.lnPrice)}, DN:${fmt(x.dnPrice)}`,
        guide: "-", cost: parseFloat(x.grandTotal?.replace(/,/g,'')||0),
        paid: x.paidDate ? parseFloat(x.grandTotal?.replace(/,/g,'')||0) : 0,
        status: `–ù—ç—Ö: ${x.invDate||'-'}<br>–¢”©–ª: ${x.paidDate||'-'}`
    }));

    collect('np_restaurant_v3', tripName, x => ({
        trip: x.trip, date: x.date, cat: "RESTAURANT", css: "row-rest",
        name: x.restaurant, desc: `${x.menuName} (${fmt(x.menuPrice)})`,
        pax: `F:${x.paxForeign}, M:${x.paxMongol}`, food: "-",
        guide: `${x.guideName||''}<br>${x.guidePhone||''}`,
        cost: parseFloat(x.grandTotal?.replace(/,/g,'')||0),
        paid: x.paidDate ? parseFloat(x.grandTotal?.replace(/,/g,'')||0) : 0,
        status: `–ù—ç—Ö: ${x.invDate||'-'}<br>–¢”©–ª: ${x.paidDate||'-'}`
    }));

    // ... (add the other collect calls similarly for gh, attraction, transport, nomad)
    // For brevity I omitted repeating them ‚Äî copy-paste from your previous version

    const selectedCats = [
        document.getElementById('cat-hotel').checked ? 'HOTEL' : null,
        document.getElementById('cat-rest').checked ? 'RESTAURANT' : null,
        document.getElementById('cat-attr').checked ? 'ATTRACTION' : null,
        document.getElementById('cat-nomad').checked ? 'NOMAD' : null,
        document.getElementById('cat-camp').checked ? 'CAMP' : null,
        document.getElementById('cat-gh').checked ? 'GUEST HOUSE' : null,
        document.getElementById('cat-trans').checked ? 'TRANSPORT' : null
    ].filter(Boolean);

    if (tripName === 'all') {
        Object.keys(groupedItems).sort().forEach(trip => {
            let items = groupedItems[trip].filter(i => selectedCats.includes(i.cat));
            if (items.length) renderTable(container, trip, items);
        });
    } else {
        let items = allItems.filter(i => selectedCats.includes(i.cat));
        if (items.length) renderTable(container, tripName, items);
    }
}

function renderTable(container, tripName, items) {
    const idSuffix = tripName.replace(/\s+/g, '_');
    let table = document.createElement('table');
    table.id = `table_${idSuffix}`;

    table.innerHTML = `
        <thead>
            <tr><th colspan="9" class="trip-header">–ê–Ø–õ–õ–´–ù –ù–≠–†: ${tripName.toUpperCase()}</th></tr>
            <tr>
                <th>–û–≥–Ω–æ–æ</th><th>–¢”©—Ä”©–ª</th><th>–ì–∞–∑—Ä—ã–Ω –ù—ç—Ä</th><th>–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π</th>
                <th>–•“Ø–Ω–∏–π –¢–æ–æ</th><th>–•–æ–æ–ª & –ë—É—Å–∞–¥</th><th>–û—Ä—á—É—É–ª–∞–≥—á / –ñ–æ–ª–æ–æ—á</th>
                <th>–ù–∏–π—Ç –î“Ø–Ω</th><th>–¢”©–ª–±”©—Ä</th>
            </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr><td colspan="7" style="text-align:right;">–ù–ò–ô–¢ –ó–ê–†–î–ê–õ:</td><td class="money-cell">${0}</td><td></td></tr>
            <tr><td colspan="7" style="text-align:right;">–¢”®–õ–°”®–ù –î“Æ–ù:</td><td class="money-cell" style="color:green;">${0}</td><td></td></tr>
            <tr><td colspan="7" style="text-align:right;">“Æ–õ–î–≠–ì–î–≠–õ:</td><td class="money-cell" style="color:red;">${0}</td><td></td></tr>
        </tfoot>
    `;

    let tbody = table.tBodies[0];
    let grand = 0, paid = 0;

    items.sort((a,b) => a.date.localeCompare(b.date)).forEach(row => {
        let tr = document.createElement('tr');
        tr.className = row.css;
        tr.innerHTML = `
            <td>${row.date || ''}</td>
            <td style="font-weight:bold;">${row.cat}</td>
            <td>${row.name || ''}</td>
            <td>${row.desc || ''}</td>
            <td>${row.pax || ''}</td>
            <td>${row.food || ''}</td>
            <td>${row.guide || ''}</td>
            <td class="money-cell">${row.cost.toLocaleString('mn-MN')}</td>
            <td style="font-size:11px;">${row.status}</td>
        `;
        tbody.appendChild(tr);
        grand += row.cost;
        paid += row.paid;
    });

    table.tFoot.rows[0].cells[1].textContent = grand.toLocaleString('mn-MN') + " ‚ÇÆ";
    table.tFoot.rows[1].cells[1].textContent = paid.toLocaleString('mn-MN') + " ‚ÇÆ";
    table.tFoot.rows[2].cells[1].textContent = (grand - paid).toLocaleString('mn-MN') + " ‚ÇÆ";

    container.appendChild(table);
    container.appendChild(document.createElement('br'));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Copy as clean TSV (best for Sheets/Excel)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyVisibleTablesAsTSV() {
    const tables = document.querySelectorAll('#tableContainer table');
    if (!tables.length) return alert("–•–∞—Ä–∞–≥–¥–∞–∂ –±—É–π —Ö“Ø—Å–Ω—ç–≥—Ç –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.");

    let tsvLines = [];

    tables.forEach((table, idx) => {
        if (idx > 0) tsvLines.push(""); // empty line between tables

        // Trip title
        const title = table.querySelector('.trip-header')?.textContent.trim() || "";
        if (title) tsvLines.push(title);

        // Headers
        const headers = Array.from(table.tHead.rows[1].cells).map(td => td.textContent.trim());
        tsvLines.push(headers.join("\t"));

        // Body rows
        Array.from(table.tBodies[0].rows).forEach(row => {
            const cells = Array.from(row.cells).map(td => td.textContent.trim().replace(/\n/g, ' | '));
            tsvLines.push(cells.join("\t"));
        });

        // Footer
        Array.from(table.tFoot.rows).forEach(row => {
            const cells = Array.from(row.cells).map(td => td.textContent.trim());
            tsvLines.push(cells.join("\t"));
        });
    });

    const tsv = tsvLines.join("\n");
    navigator.clipboard.writeText(tsv).then(() => {
        alert("TSV —Ö—É—É–ª–∞–≥–¥–ª–∞–∞! Google Sheets —ç—Å–≤—ç–ª Excel-–¥ Ctrl+V –¥–∞—Ä–∂ –Ω–∞–∞–Ω–∞ —É—É.");
    }).catch(() => {
        fallbackCopy(tsv);
    });
}

function fallbackCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed'; ta.style.opacity = 0;
    document.body.appendChild(ta);
    ta.select();
    try {
        document.execCommand('copy');
        alert("Fallback copy –∞–º–∂–∏–ª—Ç—Ç–∞–π! –ù–∞–∞–Ω–∞ —É—É.");
    } catch (e) {
        alert("–•—É—É–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –ì–∞—Ä –∞—Ä–≥–∞–∞—Ä —Å–æ–Ω–≥–æ–æ–¥ —Ö—É—É–ª–Ω–∞ —É—É.");
    }
    document.body.removeChild(ta);
}

// Optional: keep old HTML copy method
function copyVisibleTablesAsHTML() {
    const container = document.getElementById('tableContainer');
    if (!container.innerHTML.trim()) return;

    const range = document.createRange();
    range.selectNode(container);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);

    try {
        document.execCommand('copy');
        alert("HTML —Ö“Ø—Å–Ω—ç–≥—Ç(“Ø“Ø–¥) —Ö—É—É–ª–∞–≥–¥–ª–∞–∞!");
    } catch (e) {
        alert("–•—É—É–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.");
    }
    sel.removeAllRanges();
}
</script>
</body>
</html>
