<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomad Family Manager</title>
    <style>
        /* 1. FIXED FONTS & SIZES */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 100%; margin: 0 auto; }
        
        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-btn { padding: 10px 20px; text-decoration: none; color: white; background-color: #7f8c8d; border-radius: 4px; font-weight: bold; }
        .nav-btn.active { background-color: #795548; } /* Brown for Nomad */
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #795548; }
        h3 { margin-top: 0; color: #5d4037; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .big-title { font-size: 24px; font-weight: 800; color: #5d4037; text-transform: uppercase; border-bottom: 3px solid #795548; padding-bottom: 10px; margin-bottom: 15px; margin-top: 0; }
        h4 { margin: 10px 0 5px 0; color: #555; font-size: 14px; text-transform: uppercase; border-bottom: 1px dashed #ccc; padding-bottom: 5px;}

        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 100px; }
        label { font-weight: bold; font-size: 11px; display: block; margin-bottom: 5px; color: #555; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; width: 100%; box-sizing: border-box; }
        input:focus, select:focus { border-color: #795548; outline: none; }
        
        .edit-mode { border: 2px solid #f39c12; background-color: #fffdf6; }
        .total-box { background: #efebe9; padding: 10px; border: 1px solid #d7ccc8; margin-top: 10px; text-align: right; font-size: 18px; font-weight: bold; color: #5d4037; }

        button { cursor: pointer; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; }
        .btn-add { background-color: #27ae60; color: white; width: 100%; margin-top: 21px; } 
        .btn-save { background-color: #795548; color: white; width: 100%; font-size: 16px; padding: 12px; margin-top: 10px;}
        .btn-update { background-color: #f39c12; color: white; width: 100%; font-size: 16px; padding: 12px; margin-top: 10px;} 
        .btn-edit { background-color: #f39c12; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; margin-right: 5px; }
        .btn-delete { background-color: #c0392b; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; }
        /* Special Button for Schedule */
        .btn-print { background-color: #2e86c1; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; margin-right: 5px; }

        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; table-layout: auto; }
        th, td { border: 1px solid #ddd; padding: 8px 5px; text-align: center; vertical-align: middle; }
        th { background-color: #795548; color: white; font-weight: 600; font-size: 11px; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #efebe9; }
        
        .col-money { font-weight: bold; color: #2c3e50; background-color: #f4f6f7; }
        .col-total { font-weight: bold; color: #5d4037; background-color: #efebe9; font-size: 14px; }
        .info-cell { text-align: left; font-size: 12px; line-height: 1.4; }
        .date-cell { font-size: 11px; color: #666; line-height: 1.3; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <a href="index.html" class="nav-btn">1. HOTEL</a> <a href="camp.html" class="nav-btn">2. CAMP</a> <a href="restaurant.html" class="nav-btn">3. RESTAURANT</a> <a href="guesthouse.html" class="nav-btn">4. GUEST HOUSE</a> <a href="attraction.html" class="nav-btn">5. ҮЗВЭР</a> <a href="transport.html" class="nav-btn">6. ТЭЭВЭР</a>
        <a href="nomad.html" class="nav-btn active">7. МАЛЧИН</a>
    </div>

    <div class="card" style="background-color: #efebe9; border-top-color: #795548;">
        <h4>Settings (Enter дарж нэмнэ)</h4>
        <div class="row">
            <div class="col"><label>Шинэ Аялал</label><input type="text" id="newTrip" onkeypress="handleEnter(event, 'trip')"></div>
            <div class="col" style="flex:0.2"><button class="btn-add" onclick="addOpt('trip')">Нэмэх</button></div>
            <div class="col"><label>Шинэ Малчин Айл</label><input type="text" id="newNomad" onkeypress="handleEnter(event, 'nomad')"></div>
            <div class="col" style="flex:0.2"><button class="btn-add" onclick="addOpt('nomad')">Нэмэх</button></div>
        </div>
        <div class="row" style="border-top:1px dashed #d7ccc8; padding-top:10px; margin-top:10px;">
            <div class="col"><label>Шинэ Орчуулагч (Нэр)</label><input type="text" id="newGuideName"></div>
            <div class="col"><label>Утас</label><input type="text" id="newGuidePhone"></div>
            <div class="col" style="flex: 0.3;"><button class="btn-add" onclick="addNewGuide()">Хадгалах</button></div>
        </div>
    </div>

    <div class="card" id="bookingFormCard">
        <h3 id="formTitle">7. Малчин Айл Захиалга</h3>
        <input type="hidden" id="editId">
        
        <div class="row">
            <div class="col"><label>Аялал</label><select id="tripSel"></select></div>
            <div class="col"><label>Малчин Айл</label><select id="nomadSel"></select></div>
            <div class="col"><label>Ирэх Огноо</label><input type="date" id="inDate"></div>
            <div class="col"><label>Хоног</label><input type="number" id="days" value="1" oninput="calc()"></div>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">

        <h4>Гэр & Хоол (Жуулчин + Монгол)</h4>
        <div class="row">
            <div class="col"><label>Жуулчин Тоо</label><input type="number" id="paxF" oninput="calc()"></div>
            <div class="col"><label>Монгол Тоо</label><input type="number" id="paxM" oninput="calc()"></div>
            
            <div class="col" style="background:#f9e79f; padding:5px; border-radius:4px;">
                <label>Гэрийн Үнэ (Зөвхөн жуулчин)</label>
                <input type="number" id="gerPrice" placeholder="Нэгж үнэ" oninput="calc()">
            </div>
            
            <div class="col" style="background:#a9dfbf; padding:5px; border-radius:4px;">
                <label>Хоолны Үнэ (Нэгж)</label>
                <input type="number" id="foodPrice" placeholder="Нэгж үнэ" oninput="calc()">
            </div>
            <div class="col" style="background:#a9dfbf; padding:5px; border-radius:4px;">
                <label>Хоолны Давтамж</label>
                <input type="number" id="foodFreq" value="1" oninput="calc()">
            </div>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">

        <h4>Морь & Тэмээ (Хөтөч + Хүн)</h4>
        <div class="row">
            <div class="col"><label>Морь Унах Хүн</label><input type="number" id="horsePax" oninput="calc()"></div>
            <div class="col"><label>Морины Хөтөч</label><input type="number" id="horseGuide" oninput="calc()"></div>
            <div class="col"><label>Морь Үнэ (Нэгж)</label><input type="number" id="horsePrice" oninput="calc()"></div>
            <div class="col"><label>Унасан хугацаа (Өдөр)</label><input type="number" id="horseDays" value="1" oninput="calc()"></div>
        </div>
        <div class="row">
            <div class="col"><label>Тэмээ Унах Хүн</label><input type="number" id="camelPax" oninput="calc()"></div>
            <div class="col"><label>Тэмээ Хөтөч</label><input type="number" id="camelGuide" oninput="calc()"></div>
            <div class="col"><label>Тэмээ Үнэ (Нэгж)</label><input type="number" id="camelPrice" oninput="calc()"></div>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">

        <h4>Бусад & Орчуулагч</h4>
        <div class="row">
            <div class="col"><label>Нэмэлт (Хорхог/Шорлог)</label><input type="text" id="extraName"></div>
            <div class="col"><label>Нэмэлт Үнэ</label><input type="number" id="extraPrice" oninput="calc()"></div>
            
            <div class="col"><label>Орчуулагч</label><select id="guideSelect" onchange="fillGuidePhone()"><option value="">Сонгоно уу...</option></select></div>
            <div class="col"><label>Утас</label><input type="text" id="guidePhone" readonly style="background:#eee;"></div>
        </div>

        <div class="row">
            <div class="col"><label>Нэхэмжилсэн</label><input type="date" id="inv"></div>
            <div class="col"><label>Төлсөн</label><input type="date" id="paid"></div>
        </div>

        <div class="total-box">НИЙТ: <span id="totalDisplay">0</span> ₮</div>
        
        <button id="saveBtn" class="btn-save" onclick="saveData()">ХАДГАЛАХ</button>
        <button id="cancelBtn" class="btn-delete" style="display:none; margin-top:10px; padding:12px;" onclick="cancelEdit()">ЦУЦЛАХ</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 class="big-title">3. МАЛЧИН АЙЛЫН ЖАГСААЛТ (Sheet)</h3>
            <div style="display:flex; gap:10px;">
                <div style="width: 150px;"><input type="month" id="filterMonth" onchange="renderTable()" style="padding:6px;"></div>
                <div style="width: 200px;"><select id="filterNomad" onchange="renderTable()"><option value="ALL">Бүх Айл</option></select></div>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Үйлдэл</th> <th>Аялал / Айл</th> <th>Огноо / Хоног</th> 
                    <th>Хүн (Ж/М)</th> <th>Гэр/Хоол Үнэ</th> 
                    <th>Морь/Тэмээ</th> <th>Нийт Дүн</th> <th>Төлбөр</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
</div>

<script>
    let trips = JSON.parse(localStorage.getItem('np_trips')) || [];
    let nomads = JSON.parse(localStorage.getItem('np_nomads')) || [];
    let guides = JSON.parse(localStorage.getItem('np_guides')) || []; // Share guides
    let data = JSON.parse(localStorage.getItem('np_nomad_v2')) || [];

    window.onload = () => { renderOps(); renderTable(); };

    function handleEnter(e, t) { if(e.key==='Enter') addOpt(t); }
    
    function addOpt(t) {
        let v = document.getElementById(t==='trip'?'newTrip':'newNomad').value;
        if(v) { 
            if(t==='trip'){ trips.push(v); localStorage.setItem('np_trips',JSON.stringify(trips)); }
            else{ nomads.push(v); localStorage.setItem('np_nomads',JSON.stringify(nomads)); }
            document.getElementById(t==='trip'?'newTrip':'newNomad').value=''; renderOps();
        }
    }

    // --- Guide Logic ---
    function addNewGuide() {
        const name = document.getElementById('newGuideName').value;
        const phone = document.getElementById('newGuidePhone').value;
        if(name) {
            guides.push({ name: name, phone: phone });
            localStorage.setItem('np_guides', JSON.stringify(guides));
            document.getElementById('newGuideName').value = '';
            document.getElementById('newGuidePhone').value = '';
            renderOps();
        }
    }
    function fillGuidePhone() {
        const guideName = document.getElementById('guideSelect').value;
        const guide = guides.find(g => g.name === guideName);
        if(guide) document.getElementById('guidePhone').value = guide.phone;
        else document.getElementById('guidePhone').value = '';
    }
    // ------------------

    function renderOps() {
        let t=document.getElementById('tripSel'), n=document.getElementById('nomadSel'), f=document.getElementById('filterNomad');
        let g=document.getElementById('guideSelect');

        t.innerHTML=''; n.innerHTML=''; f.innerHTML='<option value="ALL">Бүх Айл</option>'; g.innerHTML='<option value="">Сонгоно уу...</option>';
        
        trips.forEach(x=>t.add(new Option(x,x))); 
        nomads.forEach(x=>{ n.add(new Option(x,x)); f.add(new Option(x,x)); });
        guides.forEach(x => g.add(new Option(x.name, x.name)));
    }

    function calc() {
        let days = parseFloat(document.getElementById('days').value)||1;
        
        // People
        let pf=parseFloat(document.getElementById('paxF').value)||0;
        let pm=parseFloat(document.getElementById('paxM').value)||0;
        
        // Ger Cost (Only Tourists Pay Ger Price)
        let gp=parseFloat(document.getElementById('gerPrice').value)||0;
        let gerTotal = (pf * gp * days); 

        // Food Cost (All People * Frequency * Price)
        let fp=parseFloat(document.getElementById('foodPrice').value)||0;
        let ff=parseFloat(document.getElementById('foodFreq').value)||1;
        let foodTotal = (pf + pm) * fp * ff;

        // Horse Cost (Pax + Guide) * Price * Duration
        let hpax=parseFloat(document.getElementById('horsePax').value)||0;
        let hguide=parseFloat(document.getElementById('horseGuide').value)||0;
        let hprice=parseFloat(document.getElementById('horsePrice').value)||0;
        let hdays=parseFloat(document.getElementById('horseDays').value)||1;
        let horseTotal = (hpax + hguide) * hprice * hdays;

        // Camel Cost
        let cpax=parseFloat(document.getElementById('camelPax').value)||0;
        let cguide=parseFloat(document.getElementById('camelGuide').value)||0;
        let cprice=parseFloat(document.getElementById('camelPrice').value)||0;
        let camelTotal = (cpax + cguide) * cprice; // Assuming per ride, add duration if needed

        let ep=parseFloat(document.getElementById('extraPrice').value)||0;

        let total = gerTotal + foodTotal + horseTotal + camelTotal + ep;
        document.getElementById('totalDisplay').innerText = total.toLocaleString();
    }

    function saveData() {
        let editId = document.getElementById('editId').value;
        let obj = {
            id: editId ? parseInt(editId) : Date.now(),
            trip: document.getElementById('tripSel').value, nomad: document.getElementById('nomadSel').value,
            inDate: document.getElementById('inDate').value, days: document.getElementById('days').value,
            
            paxF: document.getElementById('paxF').value, paxM: document.getElementById('paxM').value,
            gerPrice: document.getElementById('gerPrice').value, 
            foodPrice: document.getElementById('foodPrice').value, foodFreq: document.getElementById('foodFreq').value,
            
            horsePax: document.getElementById('horsePax').value, horseGuide: document.getElementById('horseGuide').value,
            horsePrice: document.getElementById('horsePrice').value, horseDays: document.getElementById('horseDays').value,
            
            camelPax: document.getElementById('camelPax').value, camelGuide: document.getElementById('camelGuide').value,
            camelPrice: document.getElementById('camelPrice').value,
            
            extraName: document.getElementById('extraName').value, extraPrice: document.getElementById('extraPrice').value,
            
            guide: document.getElementById('guideSelect').value, phone: document.getElementById('guidePhone').value,
            inv: document.getElementById('inv').value, paid: document.getElementById('paid').value,
            total: document.getElementById('totalDisplay').innerText
        };

        if (editId) {
            let idx = data.findIndex(x => x.id == editId);
            if(idx > -1) data[idx] = obj;
        } else {
            data.push(obj);
        }

        localStorage.setItem('np_nomad_v2', JSON.stringify(data));
        cancelEdit();
        renderTable();
    }

    function loadEdit(x) {
        document.getElementById('editId').value = x.id; document.getElementById('tripSel').value = x.trip;
        document.getElementById('nomadSel').value = x.nomad; document.getElementById('inDate').value = x.inDate;
        document.getElementById('days').value = x.days; document.getElementById('paxF').value = x.paxF;
        document.getElementById('paxM').value = x.paxM; document.getElementById('gerPrice').value = x.gerPrice;
        document.getElementById('foodPrice').value = x.foodPrice; document.getElementById('foodFreq').value = x.foodFreq || 1;
        
        document.getElementById('horsePax').value = x.horsePax; document.getElementById('horseGuide').value = x.horseGuide;
        document.getElementById('horsePrice').value = x.horsePrice; document.getElementById('horseDays').value = x.horseDays || 1;
        
        document.getElementById('camelPax').value = x.camelPax; document.getElementById('camelGuide').value = x.camelGuide;
        document.getElementById('camelPrice').value = x.camelPrice;
        
        document.getElementById('extraName').value = x.extraName; document.getElementById('extraPrice').value = x.extraPrice;
        document.getElementById('guideSelect').value = x.guide; document.getElementById('guidePhone').value = x.phone;
        document.getElementById('inv').value = x.inv; document.getElementById('paid').value = x.paid;
        calc();

        // UI
        document.getElementById('saveBtn').innerText = "ШИНЭЧЛЭХ";
        document.getElementById('saveBtn').className = "btn-update";
        document.getElementById('cancelBtn').style.display = "inline-block";
        document.getElementById('bookingFormCard').classList.add('edit-mode');
        document.getElementById('formTitle').innerText = "7. Малчин Айл (Засах)";
        document.getElementById('bookingFormCard').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        document.querySelectorAll('input').forEach(i => i.value = ''); 
        document.getElementById('totalDisplay').innerText='0';
        document.getElementById('days').value = 1;
        document.getElementById('foodFreq').value = 1;
        document.getElementById('horseDays').value = 1;
        
        document.getElementById('editId').value = "";
        document.getElementById('saveBtn').innerText = "ХАДГАЛАХ";
        document.getElementById('saveBtn').className = "btn-save";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('bookingFormCard').classList.remove('edit-mode');
        document.getElementById('formTitle').innerText = "7. Малчин Айл";
    }

    function renderTable() {
        let tb = document.getElementById('tbody');
        let filterNomad = document.getElementById('filterNomad').value;
        let filterMonth = document.getElementById('filterMonth').value;
        
        tb.innerHTML = '';
        
        data.sort((a,b)=>a.inDate>b.inDate?1:-1).forEach(x => {
            if(filterNomad !== 'ALL' && x.nomad !== filterNomad) return;
            if(filterMonth && !x.inDate.startsWith(filterMonth)) return;

            let row = tb.insertRow();
            row.innerHTML = `
            <td>
                <button class="btn-edit" onclick="loadEdit(${x.id})">Зас</button>
                <button class="btn-delete" onclick="del(${x.id})">X</button>
            </td>
            <td class="info-cell"><b>${x.trip}</b><br>${x.nomad}</td> 
            <td class="info-cell">${x.inDate}<br>(${x.days} хоног)</td>
            <td>G:${x.paxF} / M:${x.paxM}</td>
            <td class="col-money">${parseInt(x.gerPrice||0).toLocaleString()} <br> Food:${parseInt(x.foodPrice||0).toLocaleString()}</td>
            <td class="info-cell">Морь: ${parseInt(x.horsePax)+parseInt(x.horseGuide)} <br> Тэм: ${parseInt(x.camelPax)+parseInt(x.camelGuide)}</td>
            <td class="col-total">${x.total}</td>
            <td class="date-cell">
                <button class="btn-print" onclick="showSchedule('${x.nomad}','${x.inDate}','${x.paxF}','${x.paxM}','${x.guide}','${x.phone}','${x.horsePax}','${x.inDate}')">Хуваарь</button>
                <br>Н:${x.inv}<br>Т:${x.paid}
            </td>`;
        });
    }

    function showSchedule(name, date, paxF, paxM, guide, phone, horse, horseDate) {
        // This creates the "No Price" schedule view for the family
        alert(`--- АЙЛД ӨГӨХ ХУВААРЬ ---\n\n` + 
              `Айл: ${name}\n` +
              `Очих огноо: ${date}\n` +
              `Жуулчин: ${paxF} хүн\n` +
              `Монгол: ${paxM} хүн\n` +
              `Орчуулагч: ${guide} (${phone})\n` +
              `-------------------\n` +
              `Захиалга:\n` +
              `- Морь унах: ${horse} хүн (${horseDate})\n` +
              `- Хоол: Өглөө/Өдөр/Орой`);
    }

    function del(id) { 
        if(confirm('Устгах уу?')){ 
            data = data.filter(x => x.id != id); 
            localStorage.setItem('np_nomad_v2', JSON.stringify(data)); 
            renderTable(); 
        }
    }
</script>
</body>
</html>
