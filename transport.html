<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Manager</title>
    <style>
        /* 1. FIXED FONTS & SIZES */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 100%; margin: 0 auto; }
        
        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-btn { padding: 10px 20px; text-decoration: none; color: white; background-color: #7f8c8d; border-radius: 4px; font-weight: bold; }
        .nav-btn.active { background-color: #2c3e50; } /* Navy for Transport */
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #2c3e50; }
        h3 { margin-top: 0; color: #17202a; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .big-title { font-size: 24px; font-weight: 800; color: #17202a; text-transform: uppercase; border-bottom: 3px solid #2c3e50; padding-bottom: 10px; margin-bottom: 15px; margin-top: 0; }
        h4 { margin: 10px 0 5px 0; color: #555; font-size: 14px; text-transform: uppercase; border-bottom: 1px dashed #ccc; padding-bottom: 5px;}

        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 100px; }
        label { font-weight: bold; font-size: 11px; display: block; margin-bottom: 5px; color: #555; }
        input, select, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; width: 100%; box-sizing: border-box; font-family: inherit; }
        input:focus, select:focus, textarea:focus { border-color: #2c3e50; outline: none; }
        
        .edit-mode { border: 2px solid #f39c12; background-color: #fffdf6; }
        .total-box { background: #eaecee; padding: 10px; border: 1px solid #abb2b9; margin-top: 10px; text-align: right; font-size: 18px; font-weight: bold; color: #2c3e50; }

        button { cursor: pointer; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; }
        .btn-add { background-color: #27ae60; color: white; width: 100%; margin-top: 21px; } 
        .btn-save { background-color: #2c3e50; color: white; width: 100%; font-size: 16px; padding: 12px; margin-top: 10px;}
        .btn-update { background-color: #f39c12; color: white; width: 100%; font-size: 16px; padding: 12px; margin-top: 10px;} 
        .btn-edit { background-color: #f39c12; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; margin-right: 5px; }
        .btn-delete { background-color: #c0392b; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; }

        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; table-layout: auto; }
        th, td { border: 1px solid #ddd; padding: 8px 5px; text-align: center; vertical-align: middle; }
        th { background-color: #2c3e50; color: white; font-weight: 600; font-size: 11px; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #eaecee; }
        
        .col-money { font-weight: bold; color: #2c3e50; background-color: #f4f6f7; }
        .col-total { font-weight: bold; color: #17202a; background-color: #eaecee; font-size: 14px; }
        .info-cell { text-align: left; font-size: 12px; line-height: 1.4; }
        .date-cell { font-size: 11px; color: #666; line-height: 1.3; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <a href="index.html" class="nav-btn">1. HOTEL (Буудал)</a>
        <a href="restaurant.html" class="nav-btn">2. RESTAURANT</a>
        <a href="attraction.html" class="nav-btn">3. ҮЗВЭР</a>
        <a href="nomad.html" class="nav-btn">4. МАЛЧИН</a>
        <a href="camp.html" class="nav-btn">5. CAMP (Бааз)</a>
        <a href="guesthouse.html" class="nav-btn">6. GUEST HOUSE</a>
        <a href="transport.html" class="nav-btn active">7. ТЭЭВЭР</a>
        <a href="summary.html" class="nav-btn">8. НЭГДСЭН ДҮН</a>
    </div>

    <div class="card" style="background-color: #eaecee; border-top-color: #2c3e50;">
        <h4>Settings (Enter дарж нэмнэ)</h4>
        <div class="row">
            <div class="col"><label>Шинэ Аялал</label><input type="text" id="newTrip" onkeypress="handleEnter(event, 'trip')"></div>
            <div class="col" style="flex:0.2"><button class="btn-add" onclick="addOpt('trip')">Нэмэх</button></div>
            <div class="col"><label>Шинэ Тээвэрлэгч</label><input type="text" id="newTrans" onkeypress="handleEnter(event, 'trans')"></div>
            <div class="col" style="flex:0.2"><button class="btn-add" onclick="addOpt('trans')">Нэмэх</button></div>
        </div>
        
        <div class="row" style="border-top:1px dashed #bbb; padding-top:10px; margin-top:10px;">
            <div class="col"><label>Шинэ Жолооч/Орчуулагч (Нэр)</label><input type="text" id="newGuideName"></div>
            <div class="col"><label>Утас</label><input type="text" id="newGuidePhone"></div>
            <div class="col"><label>Регистр</label><input type="text" id="newGuideReg"></div>
            <div class="col" style="flex: 0.3;"><button class="btn-add" onclick="addNewGuide()">Хадгалах</button></div>
        </div>
    </div>

    <div class="card" id="bookingFormCard">
        <h3 id="formTitle">6. Тээвэр (Онгоц/Галт тэрэг/Автобус)</h3>
        <input type="hidden" id="editId">
        
        <div class="row">
            <div class="col"><label>Аялал</label><select id="tripSel"></select></div>
            <div class="col"><label>Тээвэрлэгч</label><select id="transSel"></select></div>
            <div class="col"><label>Төрөл</label><select id="type"><option>Онгоц</option><option>Галт тэрэг</option><option>Автобус</option><option>Машин</option></select></div>
            <div class="col"><label>Чиглэл (Маршрут)</label><input type="text" id="route" placeholder="УБ - Мөрөн..."></div>
        </div>

        <div class="row">
            <div class="col"><label>Явах Огноо</label><input type="date" id="date"></div>
            <div class="col"><label>Цаг</label><input type="time" id="time"></div>
            <div class="col"><label>Том хүн (Тоо)</label><input type="number" id="adlQty" oninput="calc()"></div>
            <div class="col"><label>Том хүн (Үнэ)</label><input type="number" id="adlPrice" oninput="calc()"></div>
            <div class="col"><label>Хүүхэд (Тоо)</label><input type="number" id="chdQty" oninput="calc()"></div>
            <div class="col"><label>Хүүхэд (Үнэ)</label><input type="number" id="chdPrice" oninput="calc()"></div>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">

        <div class="row">
            <div class="col" style="flex:2;">
                <label>Зорчигчийн Мэдээлэл (Нэр, Пасспорт, Төрсөн огноо, Иргэншил)</label>
                <textarea id="paxList" rows="4" placeholder="1. John Doe (Pass: E1234567, DOB: 1990.01.01, USA)&#10;2. Jane Smith (Pass: A9876543, DOB: 1995.05.05, UK)"></textarea>
            </div>
            
            <div class="col">
                <label>Жолооч/Орчуулагч Сонгох</label><select id="guideSelect" onchange="fillGuideInfo()"><option value="">Сонгоно уу...</option></select>
                <input type="text" id="guidePhone" placeholder="Утас" readonly style="background:#eee; margin-top:5px;">
                <input type="text" id="guideReg" placeholder="Регистр" readonly style="background:#eee; margin-top:5px;">
            </div>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">

        <div class="row">
            <div class="col"><label>Нэхэмжилсэн</label><input type="date" id="inv"></div>
            <div class="col"><label>Төлсөн</label><input type="date" id="paid"></div>
        </div>

        <div class="total-box">НИЙТ: <span id="totalDisplay">0</span> ₮</div>
        
        <button id="saveBtn" class="btn-save" onclick="saveData()">ХАДГАЛАХ</button>
        <button id="cancelBtn" class="btn-delete" style="display:none; margin-top:10px; padding:12px;" onclick="cancelEdit()">ЦУЦЛАХ</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 class="big-title">3. ТЭЭВРИЙН ЖАГСААЛТ (Sheet)</h3>
            <div style="display:flex; gap:10px;">
                <div style="width: 150px;"><input type="month" id="filterMonth" onchange="renderTable()" style="padding:6px;"></div>
                <div style="width: 200px;"><select id="filterTrans" onchange="renderTable()"><option value="ALL">Бүх Тээвэр</option></select></div>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Үйлдэл</th> 
                    <th>Аялал / Тээвэр</th> 
                    <th>Чиглэл / Огноо</th> 
                    <th>Зорчигчид (Пасспорт)</th> 
                    <th>Тоо / Үнэ</th> 
                    <th>Жолооч/Орч</th> 
                    <th>Нийт</th> 
                    <th>Төлбөр</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
    </div>
</div>

<script>
    let trips = JSON.parse(localStorage.getItem('np_trips')) || [];
    let trans = JSON.parse(localStorage.getItem('np_trans')) || [];
    let guides = JSON.parse(localStorage.getItem('np_trans_guides')) || []; // Specific guides for transport
    let data = JSON.parse(localStorage.getItem('np_transport_v2')) || [];

    window.onload = () => { renderOps(); renderTable(); };

    function handleEnter(e, t) { if(e.key === 'Enter') addOpt(t); }
    
    function addOpt(t) {
        let v = document.getElementById(t==='trip'?'newTrip':'newTrans').value;
        if(v) { 
            if(t==='trip'){ trips.push(v); localStorage.setItem('np_trips',JSON.stringify(trips)); }
            else{ trans.push(v); localStorage.setItem('np_trans',JSON.stringify(trans)); }
            document.getElementById(t==='trip'?'newTrip':'newTrans').value=''; renderOps();
        }
    }

    // --- Guide Logic ---
    function addNewGuide() {
        const name = document.getElementById('newGuideName').value;
        const phone = document.getElementById('newGuidePhone').value;
        const reg = document.getElementById('newGuideReg').value;
        if(name) {
            guides.push({ name: name, phone: phone, reg: reg });
            localStorage.setItem('np_trans_guides', JSON.stringify(guides));
            document.getElementById('newGuideName').value = '';
            document.getElementById('newGuidePhone').value = '';
            document.getElementById('newGuideReg').value = '';
            renderOps();
        }
    }

    function fillGuideInfo() {
        const name = document.getElementById('guideSelect').value;
        const guide = guides.find(g => g.name === name);
        if(guide) {
            document.getElementById('guidePhone').value = guide.phone;
            document.getElementById('guideReg').value = guide.reg;
        } else {
            document.getElementById('guidePhone').value = '';
            document.getElementById('guideReg').value = '';
        }
    }
    // ------------------

    function renderOps() {
        let t=document.getElementById('tripSel'), tr=document.getElementById('transSel'), f=document.getElementById('filterTrans');
        let g=document.getElementById('guideSelect');

        t.innerHTML=''; tr.innerHTML=''; f.innerHTML='<option value="ALL">Бүх Тээвэр</option>'; g.innerHTML='<option value="">Сонгоно уу...</option>';
        
        trips.forEach(x=>t.add(new Option(x,x))); 
        trans.forEach(x=>{ tr.add(new Option(x,x)); f.add(new Option(x,x)); });
        guides.forEach(x => g.add(new Option(x.name, x.name)));
    }

    function calc() {
        let aq=parseFloat(document.getElementById('adlQty').value)||0, ap=parseFloat(document.getElementById('adlPrice').value)||0;
        let cq=parseFloat(document.getElementById('chdQty').value)||0, cp=parseFloat(document.getElementById('chdPrice').value)||0;
        document.getElementById('totalDisplay').innerText = ((aq*ap)+(cq*cp)).toLocaleString();
    }

    function saveData() {
        let editId = document.getElementById('editId').value;
        let obj = {
            id: editId ? parseInt(editId) : Date.now(),
            trip: document.getElementById('tripSel').value, 
            trans: document.getElementById('transSel').value,
            type: document.getElementById('type').value, 
            route: document.getElementById('route').value,
            date: document.getElementById('date').value, 
            time: document.getElementById('time').value,
            adlQty: document.getElementById('adlQty').value, 
            adlPrice: document.getElementById('adlPrice').value,
            chdQty: document.getElementById('chdQty').value, 
            chdPrice: document.getElementById('chdPrice').value,
            paxList: document.getElementById('paxList').value, 
            
            guideName: document.getElementById('guideSelect').value,
            guidePhone: document.getElementById('guidePhone').value,
            guideReg: document.getElementById('guideReg').value,
            
            inv: document.getElementById('inv').value, 
            paid: document.getElementById('paid').value,
            total: document.getElementById('totalDisplay').innerText
        };

        if(editId) {
            let idx = data.findIndex(x => x.id == editId);
            if(idx > -1) data[idx] = obj;
        } else {
            data.push(obj);
        }

        localStorage.setItem('np_transport_v2', JSON.stringify(data));
        cancelEdit();
        renderTable();
    }

    function loadEdit(x) {
        document.getElementById('editId').value = x.id; 
        document.getElementById('tripSel').value = x.trip;
        document.getElementById('transSel').value = x.trans; 
        document.getElementById('type').value = x.type;
        document.getElementById('route').value = x.route; 
        document.getElementById('date').value = x.date;
        document.getElementById('time').value = x.time; 
        document.getElementById('adlQty').value = x.adlQty;
        document.getElementById('adlPrice').value = x.adlPrice; 
        document.getElementById('chdQty').value = x.chdQty;
        document.getElementById('chdPrice').value = x.chdPrice; 
        document.getElementById('paxList').value = x.paxList;
        
        document.getElementById('guideSelect').value = x.guideName; 
        document.getElementById('guidePhone').value = x.guidePhone;
        document.getElementById('guideReg').value = x.guideReg;
        
        document.getElementById('inv').value = x.inv;
        document.getElementById('paid').value = x.paid; 
        calc();

        // UI Change
        document.getElementById('saveBtn').innerText = "ШИНЭЧЛЭХ";
        document.getElementById('saveBtn').className = "btn-update";
        document.getElementById('cancelBtn').style.display = "inline-block";
        document.getElementById('bookingFormCard').classList.add('edit-mode');
        document.getElementById('formTitle').innerText = "6. Тээвэр (Засах)";
        document.getElementById('bookingFormCard').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        document.querySelectorAll('#bookingFormCard input, #bookingFormCard textarea, #bookingFormCard select').forEach(i => {
            if(i.id !== 'type') i.value = ''; // Don't reset type dropdown if not needed, but safer to reset all inputs
        });
        document.getElementById('type').value = 'Онгоц';
        document.getElementById('totalDisplay').innerText='0';
        document.getElementById('editId').value = "";
        
        document.getElementById('saveBtn').innerText = "ХАДГАЛАХ";
        document.getElementById('saveBtn').className = "btn-save";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('bookingFormCard').classList.remove('edit-mode');
        document.getElementById('formTitle').innerText = "6. Тээвэр (Онгоц/Галт тэрэг/Автобус)";
    }

    function renderTable() {
        let tb = document.getElementById('tbody');
        let filterTrans = document.getElementById('filterTrans').value;
        let filterMonth = document.getElementById('filterMonth').value;
        
        tb.innerHTML = '';
        
        data.sort((a,b)=>a.date>b.date?1:-1).forEach(x => {
            if(filterTrans !== 'ALL' && x.trans !== filterTrans) return;
            if(filterMonth && !x.date.startsWith(filterMonth)) return;

            let row = tb.insertRow();
            row.innerHTML = `
            <td>
                <button class="btn-edit" onclick="loadEdit(${x.id})">Зас</button>
                <button class="btn-delete" onclick="del(${x.id})">X</button>
            </td>
            <td class="info-cell"><b>${x.trip}</b><br>${x.trans} (${x.type})</td>
            <td class="info-cell">${x.route}<br>${x.date} ${x.time}</td>
            <td class="info-cell" style="font-size:11px; white-space:pre-wrap; max-width:200px; color:#555;">${x.paxList}</td>
            <td>A:${x.adlQty} / Ch:${x.chdQty}</td>
            <td class="info-cell">${x.guideName}<br><small>${x.guidePhone}</small></td>
            <td class="col-total">${x.total}</td>
            <td class="date-cell">Н:${x.inv}<br>Т:${x.paid}</td>`;
        });
    }

    function del(id) { 
        if(confirm('Устгах уу?')){ 
            data=data.filter(x=>x.id!=id); 
            localStorage.setItem('np_transport_v2',JSON.stringify(data)); 
            renderTable(); 
        }
    }
</script>
</body>
</html>
