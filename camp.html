<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camp Manager (Room Type Logic)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 100%; margin: 0 auto; }
        
        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { padding: 10px 20px; text-decoration: none; color: white; background-color: #7f8c8d; border-radius: 4px; font-weight: bold; }
        .nav-btn.active { background-color: #27ae60; }

        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #27ae60; }
        h3 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .big-title { font-size: 24px; font-weight: 800; color: #2c3e50; text-transform: uppercase; border-bottom: 3px solid #27ae60; padding-bottom: 10px; margin-bottom: 15px; margin-top: 0; }
        h4 { margin: 10px 0 5px 0; color: #555; font-size: 14px; text-transform: uppercase; border-bottom: 1px dashed #ccc; padding-bottom: 5px;}

        .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 90px; }
        label { font-weight: bold; font-size: 11px; display: block; margin-bottom: 5px; color: #555; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%; box-sizing: border-box; }
        input:focus, select:focus { border-color: #27ae60; outline: none; }
        
        .rate-box { background-color: #eafaf1; border: 1px solid #d5f5e3; padding: 15px; border-radius: 5px; }
        .total-box { background: #eafaf1; padding: 10px; border: 1px solid #abebc6; margin-top: 10px; text-align: right; font-size: 18px; font-weight: bold; color: #27ae60; }

        button { cursor: pointer; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; }
        .btn-add { background-color: #27ae60; color: white; width: 100%; margin-top: 21px; } 
        .btn-save { background-color: #27ae60; color: white; width: 100%; font-size: 16px; padding: 12px; margin-top: 10px;}
        .btn-update { background-color: #f39c12; color: white; width: 100%; font-size: 16px; padding: 12px; margin-top: 10px;} 
        .btn-edit { background-color: #f39c12; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; margin-right: 5px; }
        .btn-delete { background-color: #c0392b; color: white; padding: 4px 8px; font-size: 11px; border-radius: 4px; }
        .edit-mode { border: 2px solid #f39c12; background-color: #fffdf6; }

        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; table-layout: auto; }
        th, td { border: 1px solid #ddd; padding: 6px 4px; text-align: center; vertical-align: middle; }
        th { background-color: #2c3e50; color: white; font-weight: 600; font-size: 11px; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #eafaf1; }
        .col-money { font-weight: bold; color: #2c3e50; background-color: #f4f6f7; }
        .col-total { font-weight: bold; color: #27ae60; background-color: #d5f5e3; font-size: 14px; }
        .info-cell { text-align: left; font-size: 12px; line-height: 1.4; }
        .date-cell { font-size: 11px; color: #666; line-height: 1.3; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <a href="index.html" class="nav-btn">1. HOTEL (Буудал)</a>
        <a href="restaurant.html" class="nav-btn">2. RESTAURANT</a>
        <a href="attraction.html" class="nav-btn">3. ҮЗВЭР</a>
        <a href="nomad.html" class="nav-btn">4. МАЛЧИН</a>
        <a href="camp.html" class="nav-btn active">5. CAMP (Бааз)</a>
        <a href="guesthouse.html" class="nav-btn">6. GUEST HOUSE</a>
        <a href="transport.html" class="nav-btn">7. ТЭЭВЭР</a>
        <a href="summary.html" class="nav-btn">8. НЭГДСЭН ДҮН</a>
    </div>

    <div class="card" style="background-color: #eafaf1; border-top-color: #27ae60;">
        <h4>Settings</h4>
        <div class="row">
            <div class="col"><label>Шинэ Аялал</label><input type="text" id="newTripInput" onkeypress="handleEnter(event, 'trip')"></div>
            <div class="col" style="flex: 0.3;"><button class="btn-add" onclick="addNewOption('trip')">Нэмэх</button></div>
            
            <div class="col"><label>Шинэ Бааз</label><input type="text" id="newCampInput" onkeypress="handleEnter(event, 'camp')"></div>
            <div class="col" style="flex: 0.3;"><button class="btn-add" onclick="addNewOption('camp')">Нэмэх</button></div>
            
            <div class="col"><label>Шинэ Төрөл</label><input type="text" id="newTypeInput" placeholder="Standard, Luxe..." onkeypress="handleEnter(event, 'type')"></div>
            <div class="col" style="flex: 0.3;"><button class="btn-add" onclick="addNewOption('type')">Нэмэх</button></div>
        </div>
    </div>

    <div class="card" id="bookingFormCard">
        <h3 id="formTitle">2. Бааз Захиалга</h3>
        <input type="hidden" id="editId" value="">
        
        <div class="row">
            <div class="col"><label>Аяллын нэр</label><select id="tripSelect"></select></div>
            <div class="col"><label>Баазын нэр</label><select id="campSelect" onchange="suggestCampPrices()"></select></div>
            <div class="col"><label>Байрны Төрөл</label><select id="roomTypeSelect" onchange="suggestCampPrices()"></select></div>
            
            <div class="col"><label>Орох (Check In)</label><input type="date" id="checkIn" onchange="updateCheckOut()"></div>
            <div class="col" style="flex:0.5"><label>Хоног</label><input type="number" id="nights" value="1" oninput="updateCheckOut()"></div>
            <div class="col"><label>Гарах (Check Out)</label><input type="date" id="checkOut" onchange="updateNights()"></div>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">

        <h4>Тариф (Сонгосон төрлөөс хамаарч үнэ өөрчлөгдөнө)</h4>
        <div class="rate-box">
            <div class="row">
                <div class="col"><label>Гадаад (Том) Тоо</label><input type="number" id="faQty" value="0" oninput="calcTotal()"></div>
                <div class="col"><label>Гадаад (Том) Үнэ</label><input type="number" id="faPrice" placeholder="Auto-Fill" oninput="calcTotal()"></div>
                
                <div class="col"><label>Гадаад (Хүү) Тоо</label><input type="number" id="fcQty" value="0" oninput="calcTotal()"></div>
                <div class="col"><label>Гадаад (Хүү) Үнэ</label><input type="number" id="fcPrice" placeholder="Auto-Fill" oninput="calcTotal()"></div>
            </div>
            
            <div class="row">
                <div class="col"><label>Жолооч/Хөтөч Тоо</label><input type="number" id="staffQty" value="2" oninput="calcTotal()"></div>
                <div class="col"><label>Жолооч/Хөтөч Үнэ</label><input type="number" id="staffPrice" placeholder="Auto-Fill" oninput="calcTotal()"></div>
                <div class="col" style="flex:2"></div>
            </div>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">

        <h4>Нэмэлт Хоол (Үнэ x Бүх Хүмүүс)</h4>
        <div class="row">
            <div class="col"><label>Өглөө (Үнэ)</label><input type="number" id="bfPrice" oninput="calcTotal()"></div>
            <div class="col"><label>Өдөр (Үнэ)</label><input type="number" id="lnPrice" oninput="calcTotal()"></div>
            <div class="col"><label>Орой (Үнэ)</label><input type="number" id="dnPrice" oninput="calcTotal()"></div>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">

        <h4>Бусад & Огноо</h4>
        <div class="row">
            <div class="col"><label>Бусад/Extra</label><input type="text" id="extraName"></div>
            <div class="col"><label>Дүн</label><input type="number" id="extraPrice" value="0" oninput="calcTotal()"></div>
            <div class="col"><label style="color:red">Хөнгөлөлт</label><input type="number" id="discount" value="0" oninput="calcTotal()"></div>
            
            <div class="col"><label>Нэхэмжилсэн</label><input type="date" id="invDate"></div>
            <div class="col"><label>Төлсөн</label><input type="date" id="paidDate"></div>
        </div>

        <div class="total-box">НИЙТ: <span id="grandTotal">0</span> ₮</div>
        
        <button id="saveBtn" class="btn-save" onclick="saveBooking()">ХАДГАЛАХ</button>
        <button id="cancelBtn" class="btn-delete" style="display:none; margin-top:10px; padding:12px;" onclick="cancelEdit()">ЦУЦЛАХ</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <h3 class="big-title">3. ЖАГСААЛТ (SHEET)</h3>
            <div style="display:flex; gap:10px;">
                <div style="width: 150px;"><label>Сараар шүүх:</label><input type="month" id="filterMonth" onchange="renderTable()" style="padding:6px;"></div>
                <div style="width: 200px;"><label>Баазаар шүүх:</label><select id="filterCamp" onchange="renderTable()"><option value="ALL">Бүх Бааз</option></select></div>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Үйлдэл</th> 
                    <th style="width:18%">Аялал / Бааз</th> 
                    <th>Төрөл</th>
                    <th>Огноо</th>
                    <th>Pax Total</th> 
                    <th>Нийт</th> 
                    <th>Огноо (Н/Т)</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let trips = JSON.parse(localStorage.getItem('np_trips')) || [];
    let camps = JSON.parse(localStorage.getItem('np_camps')) || [];
    let types = JSON.parse(localStorage.getItem('np_camp_types')) || ['Standard Ger', 'Luxe Ger', 'Wooden House'];
    let bookings = JSON.parse(localStorage.getItem('np_camp_pro_v3')) || []; // Version 3
    
    // Structure: campPrices[campName][roomType] = { fa: 100, fc: 50, st: 20 }
    let campPrices = JSON.parse(localStorage.getItem('np_camp_prices_memory_v3')) || {};

    window.onload = function() {
        renderDropdowns(); renderTable(); suggestCampPrices();
    };

    // --- DATE LOGIC ---
    function updateCheckOut() {
        let checkInVal = document.getElementById('checkIn').value;
        let nightsVal = parseInt(document.getElementById('nights').value) || 0;
        if (checkInVal && nightsVal >= 0) {
            let date = new Date(checkInVal);
            date.setDate(date.getDate() + nightsVal);
            let y = date.getFullYear();
            let m = ('0' + (date.getMonth() + 1)).slice(-2);
            let d = ('0' + date.getDate()).slice(-2);
            document.getElementById('checkOut').value = `${y}-${m}-${d}`;
        }
        calcTotal();
    }

    function updateNights() {
        let d1Str = document.getElementById('checkIn').value;
        let d2Str = document.getElementById('checkOut').value;
        if (d1Str && d2Str) {
            let d1 = new Date(d1Str); let d2 = new Date(d2Str);
            let diffDays = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24)); 
            document.getElementById('nights').value = diffDays > 0 ? diffDays : 0;
        }
        calcTotal();
    }

    // --- PRICE MEMORY LOGIC (Camp + Type Specific) ---
    function suggestCampPrices() {
        const camp = document.getElementById('campSelect').value;
        const type = document.getElementById('roomTypeSelect').value;
        
        if (camp && type && campPrices[camp] && campPrices[camp][type]) {
            const p = campPrices[camp][type];
            document.getElementById('faPrice').value = p.fa || '';
            document.getElementById('fcPrice').value = p.fc || '';
            document.getElementById('staffPrice').value = p.st || '';
        } else {
            document.getElementById('faPrice').value = '';
            document.getElementById('fcPrice').value = '';
            document.getElementById('staffPrice').value = '';
        }
        calcTotal();
    }

    function saveCurrentCampPrices(camp, type) {
        if (!camp || !type) return;
        
        if (!campPrices[camp]) campPrices[camp] = {};
        
        campPrices[camp][type] = {
            fa: document.getElementById('faPrice').value,
            fc: document.getElementById('fcPrice').value,
            st: document.getElementById('staffPrice').value
        };
        localStorage.setItem('np_camp_prices_memory_v3', JSON.stringify(campPrices));
    }

    function handleEnter(e, type) { if(e.key === 'Enter') { addNewOption(type); } }

    function calcTotal() {
        let nights = parseFloat(document.getElementById('nights').value) || 0;

        let faQ = parseFloat(document.getElementById('faQty').value) || 0;
        let fcQ = parseFloat(document.getElementById('fcQty').value) || 0;
        let stQ = parseFloat(document.getElementById('staffQty').value) || 0;

        let faP = parseFloat(document.getElementById('faPrice').value) || 0;
        let fcP = parseFloat(document.getElementById('fcPrice').value) || 0;
        let stP = parseFloat(document.getElementById('staffPrice').value) || 0;

        let accomTotal = ((faQ * faP) + (fcQ * fcP) + (stQ * stP)) * nights;

        let totalPax = faQ + fcQ + stQ;
        let bf = parseFloat(document.getElementById('bfPrice').value) || 0;
        let ln = parseFloat(document.getElementById('lnPrice').value) || 0;
        let dn = parseFloat(document.getElementById('dnPrice').value) || 0;
        
        let foodTotal = (bf + ln + dn) * totalPax;

        let extra = parseFloat(document.getElementById('extraPrice').value) || 0;
        let disc = parseFloat(document.getElementById('discount').value) || 0;

        let grand = accomTotal + foodTotal + extra - disc;
        document.getElementById('grandTotal').innerText = grand.toLocaleString();
    }

    function addNewOption(type) {
        if (type === 'trip') {
            const val = document.getElementById('newTripInput').value;
            if (val) { trips.push(val); localStorage.setItem('np_trips', JSON.stringify(trips)); document.getElementById('newTripInput').value = ''; renderDropdowns(); }
        } else if (type === 'camp') {
            const val = document.getElementById('newCampInput').value;
            if (val) { camps.push(val); localStorage.setItem('np_camps', JSON.stringify(camps)); document.getElementById('newCampInput').value = ''; renderDropdowns(); }
        } else if (type === 'type') {
            const val = document.getElementById('newTypeInput').value;
            if (val) { types.push(val); localStorage.setItem('np_camp_types', JSON.stringify(types)); document.getElementById('newTypeInput').value = ''; renderDropdowns(); }
        }
    }

    function renderDropdowns() {
        const tripSel = document.getElementById('tripSelect'); 
        const campSel = document.getElementById('campSelect'); 
        const typeSel = document.getElementById('roomTypeSelect');
        const filterSel = document.getElementById('filterCamp');
        
        const currTrip = tripSel.value; const currCamp = campSel.value; 
        const currType = typeSel.value; const currFilter = filterSel.value;

        tripSel.innerHTML = ''; campSel.innerHTML = ''; typeSel.innerHTML = '';
        filterSel.innerHTML = '<option value="ALL">Бүх Бааз</option>';
        
        trips.forEach(t => { tripSel.add(new Option(t, t)); });
        camps.forEach(c => { campSel.add(new Option(c, c)); filterSel.add(new Option(c, c)); });
        types.forEach(t => { typeSel.add(new Option(t, t)); });

        if(currTrip) tripSel.value = currTrip;
        if(currCamp) { campSel.value = currCamp; }
        if(currType) typeSel.value = currType;
        if(currFilter) filterSel.value = currFilter;
        
        // Trigger suggest after render if camp selected
        suggestCampPrices();
    }

    function saveBooking() {
        const editId = document.getElementById('editId').value;
        const campName = document.getElementById('campSelect').value;
        const typeName = document.getElementById('roomTypeSelect').value;
        
        // Save Prices Logic
        saveCurrentCampPrices(campName, typeName);

        const data = {
            id: editId ? parseInt(editId) : Date.now(),
            trip: document.getElementById('tripSelect').value,
            camp: campName,
            roomType: typeName,
            checkIn: document.getElementById('checkIn').value,
            checkOut: document.getElementById('checkOut').value,
            nights: document.getElementById('nights').value,
            
            faQty: document.getElementById('faQty').value, faPrice: document.getElementById('faPrice').value,
            fcQty: document.getElementById('fcQty').value, fcPrice: document.getElementById('fcPrice').value,
            stQty: document.getElementById('staffQty').value, stPrice: document.getElementById('staffPrice').value,

            bfPrice: document.getElementById('bfPrice').value,
            lnPrice: document.getElementById('lnPrice').value,
            dnPrice: document.getElementById('dnPrice').value,
            
            extraName: document.getElementById('extraName').value, 
            extraPrice: document.getElementById('extraPrice').value,
            discount: document.getElementById('discount').value,
            grandTotal: document.getElementById('grandTotal').innerText,
            invDate: document.getElementById('invDate').value,
            paidDate: document.getElementById('paidDate').value
        };

        if (editId) { let idx = bookings.findIndex(b => b.id == editId); if (idx !== -1) bookings[idx] = data; } 
        else { bookings.push(data); }
        
        localStorage.setItem('np_camp_pro_v3', JSON.stringify(bookings));
        cancelEdit(); renderTable();
    }

    function editBooking(id) {
        const b = bookings.find(item => item.id == id); if (!b) return;
        document.getElementById('editId').value = b.id;
        document.getElementById('tripSelect').value = b.trip; 
        document.getElementById('campSelect').value = b.camp;
        
        // Load Room Type (might need to add to list if deleted, but assuming standard list)
        if (!types.includes(b.roomType)) {
             let opt = new Option(b.roomType, b.roomType);
             document.getElementById('roomTypeSelect').add(opt);
        }
        document.getElementById('roomTypeSelect').value = b.roomType;
        
        document.getElementById('checkIn').value = b.checkIn; 
        document.getElementById('checkOut').value = b.checkOut;
        document.getElementById('nights').value = b.nights;

        document.getElementById('faQty').value = b.faQty; document.getElementById('faPrice').value = b.faPrice;
        document.getElementById('fcQty').value = b.fcQty; document.getElementById('fcPrice').value = b.fcPrice;
        document.getElementById('staffQty').value = b.stQty; document.getElementById('staffPrice').value = b.stPrice;

        document.getElementById('bfPrice').value = b.bfPrice || "";
        document.getElementById('lnPrice').value = b.lnPrice || "";
        document.getElementById('dnPrice').value = b.dnPrice || "";

        document.getElementById('extraName').value = b.extraName; 
        document.getElementById('extraPrice').value = b.extraPrice;
        document.getElementById('discount').value = b.discount;
        document.getElementById('grandTotal').innerText = b.grandTotal;
        document.getElementById('invDate').value = b.invDate || "";
        document.getElementById('paidDate').value = b.paidDate || "";

        document.getElementById('saveBtn').innerText = "ШИНЭЧЛЭХ"; document.getElementById('saveBtn').className = "btn-update";
        document.getElementById('cancelBtn').style.display = "inline-block";
        document.getElementById('bookingFormCard').classList.add('edit-mode');
        document.getElementById('bookingFormCard').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        document.querySelectorAll('#bookingFormCard input').forEach(i => i.value = '');
        document.getElementById('nights').value = 1; 
        document.getElementById('grandTotal').innerText = '0';
        document.getElementById('faQty').value = 0; document.getElementById('fcQty').value = 0;
        document.getElementById('staffQty').value = 2; 
        
        suggestCampPrices(); 
        
        document.getElementById('editId').value = "";
        document.getElementById('saveBtn').innerText = "ХАДГАЛАХ"; document.getElementById('saveBtn').className = "btn-save";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('bookingFormCard').classList.remove('edit-mode');
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        const filterCamp = document.getElementById('filterCamp').value;
        const filterMonth = document.getElementById('filterMonth').value;
        
        bookings.sort((a, b) => (a.checkIn > b.checkIn) ? 1 : -1);

        bookings.forEach((b) => {
            if (filterCamp !== "ALL" && b.camp !== filterCamp) return;
            if (filterMonth && !b.checkIn.startsWith(filterMonth)) return;
            
            let row = tbody.insertRow();
            
            let accomTotal = ((b.faQty*b.faPrice) + (b.fcQty*b.fcPrice) + (b.stQty*b.stPrice)) * b.nights;

            row.innerHTML = `
                <td><button class="btn-edit" onclick="editBooking(${b.id})">Зас</button><button class="btn-delete" onclick="deleteBooking(${b.id})">X</button></td>
                <td class="info-cell"><b>${b.trip}</b><br>${b.camp}</td>
                <td class="info-cell">${b.roomType || '-'}</td>
                <td class="info-cell">${b.checkIn}<br><b>${b.nights} хон</b></td>
                
                <td class="col-money" style="background:#e8f8f5">${accomTotal.toLocaleString()}</td>
                
                <td class="col-total">${b.grandTotal}</td>
                <td class="date-cell">Н: ${b.invDate || '-'}<br>Т: ${b.paidDate || '-'}</td>`;
        });
    }

    function deleteBooking(id) {
        if(confirm("Устгах уу?")) {
            const index = bookings.findIndex(b => b.id == id);
            if (index > -1) { bookings.splice(index, 1); localStorage.setItem('np_camp_pro_v3', JSON.stringify(bookings)); renderTable(); }
        }
    }
</script>

</body>
</html>
