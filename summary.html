<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù—ç–≥–¥—Å—ç–Ω –¢–∞–π–ª–∞–Ω (Final Summary)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 100%; margin: 0 auto; }
        
        /* Main Navigation (Links to other pages) */
        .nav-bar { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-btn { padding: 8px 15px; text-decoration: none; color: white; background: #7f8c8d; border-radius: 4px; font-weight: bold; font-size: 12px; }
        .nav-btn.active { background: #2c3e50; border: 2px solid #f1c40f; } 

        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .row { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 20px; }
        
        select { padding: 10px; font-size: 16px; border: 2px solid #27ae60; border-radius: 4px; width: 300px; }
        .btn-copy { background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-copy:hover { background: #2ecc71; }

        /* --- NEW FILTER BUTTONS STYLE --- */
        .filter-bar { margin-bottom: 15px; display: flex; gap: 5px; flex-wrap: wrap; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .filter-btn { 
            padding: 8px 16px; 
            border: 1px solid #ccc; 
            background: #fff; 
            cursor: pointer; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: 600;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: #eee; }
        .filter-btn.active-filter { 
            background: #3498db; 
            color: white; 
            border-color: #2980b9; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* GOOGLE SHEETS READY TABLE STYLE */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
            font-size: 12px; 
            font-family: Arial, sans-serif; 
            border: 1px solid #000;
        }
        th, td { 
            border: 1px solid #000; 
            padding: 8px; 
            text-align: left; 
            vertical-align: top;
        }
        th { background-color: #dcdcdc; font-weight: bold; text-transform: uppercase; }
        
        /* Trip Name Header Style */
        .trip-header { background-color: #4a69bd; color: white; font-size: 18px; text-align: center; padding: 15px; }

        /* Category Colors */
        .row-hotel { border-left: 5px solid #2980b9; }
        .row-camp { border-left: 5px solid #e67e22; }
        .row-rest { border-left: 5px solid #e74c3c; }
        .row-gh { border-left: 5px solid #8e44ad; }
        .row-attr { border-left: 5px solid #16a085; }
        .row-trans { border-left: 5px solid #2c3e50; }
        .row-nomad { border-left: 5px solid #795548; }

        /* Footer Totals */
        tfoot tr td { background-color: #f9e79f; font-weight: bold; font-size: 13px; border: 1px solid #000; }
        .money-cell { text-align: right; white-space: nowrap; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <a href="index.html" class="nav-btn">1. HOTEL (–ë—É—É–¥–∞–ª)</a>
        <a href="restaurant.html" class="nav-btn">2. RESTAURANT</a>
        <a href="attraction.html" class="nav-btn">3. “Æ–ó–í–≠–†</a>
        <a href="nomad.html" class="nav-btn">4. –ú–ê–õ–ß–ò–ù</a>
        <a href="camp.html" class="nav-btn">5. CAMP (–ë–∞–∞–∑)</a>
        <a href="guesthouse.html" class="nav-btn">6. GUEST HOUSE</a>
        <a href="transport.html" class="nav-btn">7. –¢–≠–≠–í–≠–†</a>
        <a href="summary.html" class="nav-btn active">8. –ù–≠–ì–î–°–≠–ù –î“Æ–ù</a>
    </div>

    <div class="card">
        <div class="row">
            <div>
                <label style="display:block; font-weight:bold; margin-bottom:5px;">–ê—è–ª–∞–ª –°–æ–Ω–≥–æ—Ö:</label>
                <select id="tripSelect" onchange="resetAndGenerate()"><option value="">-- –ê—è–ª–∞–ª —Å–æ–Ω–≥–æ–Ω–æ —É—É --</option></select>
            </div>
            <div>
                <button class="btn-copy" onclick="copyAndOpenSheets()">üìã EXCEL / SHEETS –•–£–£–õ–ê–•</button>
            </div>
        </div>

        <div class="filter-bar" id="filterContainer" style="display:none;">
            <button class="filter-btn active-filter" onclick="applyFilter('ALL', this)">–ë“Æ–ì–î (ALL)</button>
            <button class="filter-btn" onclick="applyFilter('HOTEL', this)">HOTEL</button>
            <button class="filter-btn" onclick="applyFilter('CAMP', this)">CAMP</button>
            <button class="filter-btn" onclick="applyFilter('GUEST HOUSE', this)">GUEST HOUSE</button>
            <button class="filter-btn" onclick="applyFilter('RESTAURANT', this)">RESTAURANT</button>
            <button class="filter-btn" onclick="applyFilter('ATTRACTION', this)">“Æ–ó–í–≠–†</button>
            <button class="filter-btn" onclick="applyFilter('NOMAD', this)">–ú–ê–õ–ß–ò–ù</button>
            <button class="filter-btn" onclick="applyFilter('TRANSPORT', this)">–¢–≠–≠–í–≠–†</button>
        </div>

        <div id="tableContainer">
            <table id="masterTable">
                <thead>
                    <tr id="tripNameRow" style="display:none;">
                        <th colspan="9" class="trip-header" id="tableTripTitle">–ê–Ø–õ–õ–´–ù –ù–≠–†</th>
                    </tr>
                    <tr>
                        <th style="width:80px;">–û–≥–Ω–æ–æ</th>
                        <th style="width:110px;">–¢”©—Ä”©–ª</th>
                        <th style="width:150px;">–ì–∞–∑—Ä—ã–Ω –ù—ç—Ä</th>
                        <th>–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π (”®—Ä”©”© / –ú–µ–Ω—é / –£–Ω–∞–∞)</th>
                        <th>–•“Ø–Ω–∏–π –¢–æ–æ (Pax)</th>
                        <th>–•–æ–æ–ª & –ë—É—Å–∞–¥</th>
                        <th>–û—Ä—á—É—É–ª–∞–≥—á / –ñ–æ–ª–æ–æ—á</th>
                        <th>–ù–∏–π—Ç –î“Ø–Ω</th>
                        <th>–¢”©–ª–±”©—Ä</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
                <tfoot id="tfoot" style="display:none;">
                    <tr>
                        <td colspan="7" style="text-align:right;">–ù–ò–ô–¢ –ó–ê–†–î–ê–õ:</td>
                        <td class="money-cell" id="footerTotal">0</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="7" style="text-align:right;">–¢”®–õ–°”®–ù –î“Æ–ù:</td>
                        <td class="money-cell" id="footerPaid" style="color:green;">0</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="7" style="text-align:right;">“Æ–õ–î–≠–ì–î–≠–õ:</td>
                        <td class="money-cell" id="footerBalance" style="color:red;">0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<script>
    // --- LOAD DATA ---
    let trips = JSON.parse(localStorage.getItem('np_trips')) || [];
    let currentCategoryFilter = 'ALL'; // Default filter

    // Helper: Number Format
    const fmt = (num) => num ? parseInt(num).toLocaleString() : '0';

    window.onload = function() {
        let sel = document.getElementById('tripSelect');
        trips.forEach(t => sel.add(new Option(t, t)));
    };

    function resetAndGenerate() {
        // Reset filter to ALL when changing trips
        currentCategoryFilter = 'ALL';
        // Reset buttons visual
        let btns = document.querySelectorAll('.filter-btn');
        btns.forEach(b => b.classList.remove('active-filter'));
        btns[0].classList.add('active-filter');
        
        generateReport();
    }

    function applyFilter(category, btnElement) {
        currentCategoryFilter = category;
        
        // Update Button Styles
        let btns = document.querySelectorAll('.filter-btn');
        btns.forEach(b => b.classList.remove('active-filter'));
        btnElement.classList.add('active-filter');

        generateReport();
    }

    function generateReport() {
        const tripName = document.getElementById('tripSelect').value;
        const tbody = document.getElementById('tbody');
        const tfoot = document.getElementById('tfoot');
        const tripTitleRow = document.getElementById('tripNameRow');
        const filterContainer = document.getElementById('filterContainer');
        
        tbody.innerHTML = '';
        let grandTotal = 0;
        let paidTotal = 0;
        let allItems = [];

        if(!tripName) {
            tfoot.style.display = 'none';
            tripTitleRow.style.display = 'none';
            filterContainer.style.display = 'none';
            return;
        }

        // Show UI Elements
        tripTitleRow.style.display = 'table-row';
        filterContainer.style.display = 'flex';
        document.getElementById('tableTripTitle').innerText = "–ê–Ø–õ–õ–´–ù –ù–≠–†: " + tripName.toUpperCase();

        // --- GATHER DATA ---

        // 1. HOTEL
        let hotels = JSON.parse(localStorage.getItem('np_hotel_pro_v3')) || [];
        hotels.forEach(x => {
            if(x.trip === tripName) {
                let roomStr = "";
                if(x.rooms) x.rooms.forEach(r => roomStr += `${r.type} x${r.count}, `);
                let cost = parseFloat(x.grandTotal.replace(/,/g,'')) || 0;
                allItems.push({
                    date: x.checkIn, cat: "HOTEL", css: "row-hotel",
                    name: x.hotel, desc: roomStr + `(${x.nights} —Ö–æ–Ω–æ–≥)`,
                    pax: `Total: ${x.paxCount}`, food: `BF:${fmt(x.bfPrice)}, LN:${fmt(x.lnPrice)}, DN:${fmt(x.dnPrice)}`,
                    guide: `-`, cost: cost, paidDate: x.paidDate,
                    status: `–ù—ç—Ö: ${x.invDate || '-'} <br> –¢”©–ª: ${x.paidDate || '-'}`
                });
            }
        });

        // 2. CAMP
        let camps = JSON.parse(localStorage.getItem('np_camp_pro_v3')) || [];
        camps.forEach(x => {
            if(x.trip === tripName) {
                let cost = parseFloat(x.grandTotal.replace(/,/g,'')) || 0;
                allItems.push({
                    date: x.checkIn, cat: "CAMP", css: "row-camp",
                    name: x.camp, desc: `${x.roomType || 'Standard'} (${x.nights} —Ö–æ–Ω–æ–≥)`,
                    pax: `F:${x.faQty}, C:${x.fcQty}, S:${x.stQty}`, food: `BF:${fmt(x.bfPrice)}, LN:${fmt(x.lnPrice)}, DN:${fmt(x.dnPrice)}`,
                    guide: `-`, cost: cost, paidDate: x.paidDate,
                    status: `–ù—ç—Ö: ${x.invDate || '-'} <br> –¢”©–ª: ${x.paidDate || '-'}`
                });
            }
        });

        // 3. RESTAURANT
        let rests = JSON.parse(localStorage.getItem('np_restaurant_v3')) || [];
        rests.forEach(x => {
            if(x.trip === tripName) {
                let cost = parseFloat(x.grandTotal.replace(/,/g,'')) || 0;
                allItems.push({
                    date: x.date, cat: "RESTAURANT", css: "row-rest",
                    name: x.restaurant, desc: `${x.menuName} (${fmt(x.menuPrice)})`,
                    pax: `F:${x.paxForeign}, M:${x.paxMongol}`, food: `-`,
                    guide: `${x.guideName}<br>${x.guidePhone}`, cost: cost, paidDate: x.paidDate,
                    status: `–ù—ç—Ö: ${x.invDate || '-'} <br> –¢”©–ª: ${x.paidDate || '-'}`
                });
            }
        });

        // 4. GUEST HOUSE
        let ghs = JSON.parse(localStorage.getItem('np_gh_bookings_v3')) || [];
        ghs.forEach(x => {
            if(x.trip === tripName) {
                let cost = parseFloat(x.grandTotal.replace(/,/g,'')) || 0;
                allItems.push({
                    date: x.checkIn, cat: "GUEST HOUSE", css: "row-gh",
                    name: x.gh, desc: `${x.accomType} (${x.nights} —Ö–æ–Ω–æ–≥)`,
                    pax: `F:${x.forAdlQty}, C:${x.forChdQty}, S:${x.stQty}`, food: `BF:${fmt(x.bfPrice)}, LN:${fmt(x.lnPrice)}, DN:${fmt(x.dnPrice)}`,
                    guide: `-`, cost: cost, paidDate: x.paidDate,
                    status: `–ù—ç—Ö: ${x.invDate || '-'} <br> –¢”©–ª: ${x.paidDate || '-'}`
                });
            }
        });

        // 5. ATTRACTION
        let attrs = JSON.parse(localStorage.getItem('np_attraction_v3')) || [];
        attrs.forEach(x => {
            if(x.trip === tripName) {
                let cost = parseFloat(x.total.replace(/,/g,'')) || 0;
                allItems.push({
                    date: x.date, cat: "ATTRACTION", css: "row-attr",
                    name: x.attr, desc: `Time: ${x.time}`,
                    pax: `Adl:${x.adlQty}, Chd:${x.chdQty}`, food: `-`,
                    guide: `${x.guide}<br>${x.phone}`, cost: cost, paidDate: x.paid,
                    status: `–ù—ç—Ö: ${x.inv || '-'} <br> –¢”©–ª: ${x.paid || '-'}`
                });
            }
        });

        // 6. TRANSPORT
        let trans = JSON.parse(localStorage.getItem('np_transport_v2')) || [];
        trans.forEach(x => {
            if(x.trip === tripName) {
                let cost = parseFloat(x.total.replace(/,/g,'')) || 0;
                allItems.push({
                    date: x.date, cat: "TRANSPORT", css: "row-trans",
                    name: x.trans, desc: `${x.type} - ${x.route}`,
                    pax: `Adl:${x.adlQty}, Chd:${x.chdQty}`, food: `-`,
                    guide: `${x.guideName}<br>${x.guidePhone}`, cost: cost, paidDate: x.paid,
                    status: `–ù—ç—Ö: ${x.inv || '-'} <br> –¢”©–ª: ${x.paid || '-'}`
                });
            }
        });

        // 7. NOMAD
        let nomads = JSON.parse(localStorage.getItem('np_nomad_v4')) || [];
        nomads.forEach(x => {
            if(x.trip === tripName) {
                let cost = parseFloat(x.total.replace(/,/g,'')) || 0;
                let rideStr = `Ride Pax:${x.ridePax}, Guide:${x.rideGuide} (${x.rideDays}d)`;
                allItems.push({
                    date: x.inDate, cat: "NOMAD", css: "row-nomad",
                    name: x.nomad, desc: `Ger Stay (${x.days} days)`,
                    pax: `F:${x.paxF}, M:${x.paxM}`, food: `Price:${fmt(x.foodPrice)}, Freq:${x.foodFreq}`,
                    guide: `${rideStr}<br>Guide:${x.guide}`, cost: cost, paidDate: x.paid,
                    status: `–ù—ç—Ö: ${x.inv || '-'} <br> –¢”©–ª: ${x.paid || '-'}`
                });
            }
        });

        // --- SORT ---
        allItems.sort((a, b) => (a.date > b.date) ? 1 : -1);

        // --- FILTER LOGIC ---
        let filteredItems = allItems;
        if(currentCategoryFilter !== 'ALL') {
            filteredItems = allItems.filter(item => item.cat === currentCategoryFilter);
        }

        // --- RENDER & CALCULATE TOTALS ---
        filteredItems.forEach(row => {
            // Add to totals
            grandTotal += row.cost;
            if(row.paidDate) paidTotal += row.cost;

            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="${row.css}">${row.date}</td>
                <td style="font-weight:bold;">${row.cat}</td>
                <td>${row.name}</td>
                <td>${row.desc}</td>
                <td>${row.pax}</td>
                <td>${row.food}</td>
                <td>${row.guide}</td>
                <td class="money-cell" style="font-weight:bold;">${row.cost.toLocaleString()}</td>
                <td style="font-size:11px;">${row.status}</td>
            `;
            tbody.appendChild(tr);
        });

        // --- UPDATE FOOTER ---
        document.getElementById('footerTotal').innerText = grandTotal.toLocaleString() + " ‚ÇÆ";
        document.getElementById('footerPaid').innerText = paidTotal.toLocaleString() + " ‚ÇÆ";
        document.getElementById('footerBalance').innerText = (grandTotal - paidTotal).toLocaleString() + " ‚ÇÆ";
        tfoot.style.display = 'table-footer-group';
    }

    function copyAndOpenSheets() {
        const table = document.getElementById('masterTable');
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        
        try {
            document.execCommand('copy');
            window.open('https://sheets.google.com/create', '_blank');
        } catch (err) {
            alert('Copy failed.');
        }
        window.getSelection().removeAllRanges();
    }
</script>

</body>
</html>
